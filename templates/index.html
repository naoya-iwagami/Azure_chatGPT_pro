<!DOCTYPE html>  
<html lang="ja">  
<head>  
  <meta charset="UTF-8">  
  <title>PM Compass PRO</title>  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">  
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css">  
    
  <!-- MathJax 設定 & 読み込み（LaTeX用） -->  
  <script>  
    window.MathJax = {  
      tex: {  
        // インライン数式: $...$  
        inlineMath: [['$', '$']],  
        // 別行数式: $$...$$ または $...$  
        displayMath: [['$$', '$$'], ['\$', '\$']],  
        processEscapes: true  
      },  
      svg: { fontCache: 'global' }  
    };  
  </script>  
  <script id="MathJax-script" async  
          src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>  
    
  <style>  
    #loadingInline { display: none; align-items: center;}  
    #loadingInline .loading-text { font-size: 1rem; color: #333; margin-left: 0.5em;}  
    #searchFilesDisplay {margin-bottom:1em;}  
    #searchFilesDisplay ul {margin-bottom:0; padding-left:1.2em;}  
    .small-muted { font-size: 0.9em; color: #666; }  
    #searchFilesUlContainer {  
        max-height: 50vh;  
        overflow-y: auto;  
        border: 1px solid #e0e0e0;  
        background: #fff;  
        margin-top: .5rem;  
        padding: .5rem .75rem;  
    }  
    #searchFilesUlContainer ul {  
        margin: 0;  
        padding-left: 1.2em;  
    }  
  </style>  
</head>  
<body>  
<div class="container-fluid">  
  <div class="row">  
    <!-- サイドバー -->  
    <div class="col-md-3 sidebar">  
      <h4>モデル設定</h4>  
      <form method="POST" style="margin-bottom: 1em;">  
        <div class="form-group">  
          <label for="model_select">モデルを選択</label>  
          <select id="model_select" name="model" class="form-control">  
            <option value="gpt-4o" {% if session.get('selected_model') == 'gpt-4o' %}selected{% endif %}>gpt-4o</option>  
            <option value="gpt-4.1" {% if session.get('selected_model') == 'gpt-4.1' %}selected{% endif %}>gpt-4.1</option>  
            <option value="o3" {% if session.get('selected_model') == 'o3' %}selected{% endif %}>o3</option>  
            <option value="o4-mini" {% if session.get('selected_model') == 'o4-mini' %}selected{% endif %}>o4-mini</option>  
            <option value="gpt-5" {% if session.get('selected_model') == 'gpt-5' %}selected{% endif %}>gpt-5</option>  
          </select>  
          <input type="hidden" name="set_model" value="1">  
        </div>  
        <div class="form-group">  
          <label for="reasoning_effort">reasoning_effort</label>  
          <select id="reasoning_effort" name="reasoning_effort" class="form-control"  
                  {% if session.get('selected_model') not in ['o3','o4-mini','gpt-5'] %}disabled{% endif %}>  
            {% set eff = session.get('reasoning_effort', 'high') %}  
            <option value="low" {% if eff == 'low' %}selected{% endif %}>low</option>  
            <option value="medium" {% if eff == 'medium' %}selected{% endif %}>medium</option>  
            <option value="high" {% if eff == 'high' %}selected{% endif %}>high</option>  
          </select>  
          <small class="form-text text-muted">  
            o3 / o4-mini / gpt-5 選択時のみ有効です。  
          </small>  
        </div>  
      </form>  
    
      <h4>検索設定</h4>  
      <div class="small-muted">検索方法: ハイブリッド（キーワード＋セマンティック＋ベクターのRRF融合）</div>  
      <form method="POST" style="margin-bottom: 1em; margin-top: .5em;">  
        <div class="form-group">  
          <label for="index_select">検索インデックス</label>  
          <select id="index_select" name="search_index" class="form-control">  
            {% set selected_idx = session.get('selected_search_index') %}  
            {% for label, value in index_options %}  
              <option value="{{ value }}" {% if selected_idx == value %}selected{% endif %}>  
                {{ label }}  
              </option>  
            {% endfor %}  
          </select>  
          <input type="hidden" name="set_index" value="1">  
        </div>  
      </form>  
    
      <form method="POST" style="margin-bottom: 1em;">  
        <div class="form-group">  
          <label for="doc_count">取得ドキュメント数（1～300）</label>  
          <input type="number" id="doc_count" name="doc_count"  
                 class="form-control" min="1" max="300" step="1"  
                 value="{{ session.get('doc_count', 10) }}">  
          <input type="hidden" name="set_doc_count" value="1">  
          <small class="form-text text-muted">多くするほど文脈は増えますが、応答時間も長くなります。</small>  
        </div>  
      </form>  
    
      <form method="POST" style="margin-bottom: 1em;">  
        <div class="form-group">  
          <label for="history_to_send">過去メッセージ数（1～50）</label>  
          <input type="number" id="history_to_send" name="history_to_send"  
                 class="form-control" min="1" max="50" step="1"  
                 value="{{ session.get('history_to_send', 10) }}">  
          <input type="hidden" name="set_history_to_send" value="1">  
          <small class="form-text text-muted">モデルに渡す直近の発話数を指定します。</small>  
        </div>  
      </form>  
    
      <!-- RAG ON/OFF スイッチ -->  
      <div class="form-group">  
        <div class="custom-control custom-switch">  
          <input type="checkbox" class="custom-control-input" id="ragEnabled"  
                 {% if session.get('rag_enabled', True) %}checked{% endif %}>  
          <label class="custom-control-label" for="ragEnabled">RAGを使用する</label>  
        </div>  
        <small class="form-text text-muted">  
          OFFにすると社内検索を行わず、会話と添付のみで回答します。  
        </small>  
      </div>  
    
      <h5>モデルに指示を与える</h5>  
      <!-- 現在のsystem_messageを直接編集 -->  
      <form method="POST" style="margin-bottom: 1em;">  
        <div class="form-group">  
          <textarea class="form-control" name="system_message" rows="4"  
          >{{ session.get(  
              'default_system_message',  
              'あなたは親切なAIアシスタントです。ユーザーの質問が不明確な場合は、「こういうことですか？」と内容を確認してください。質問が明確な場合は、簡潔かつ正確に答えてください。数式を含む場合は LaTeX で表記し、インライン数式は $...$、ディスプレイ数式は $$...$$ または \$...\$ で囲んでください.'  
          ) }}</textarea>  
          <input type="hidden" name="set_system_message" value="1">  
        </div>  
      </form>  
    
      <!-- 登録済みの指示から選ぶ -->  
      <form method="POST" style="margin-bottom: 1em;">  
        <div class="form-group">  
          <label for="select_prompt_id">登録済みの指示を選択</label>  
          <select id="select_prompt_id" name="select_prompt_id" class="form-control" onchange="this.form.submit()">  
            <option value="">-- 選択してください --</option>  
            {% for p in saved_prompts %}  
              <option value="{{ p.id }}">{{ p.title }}</option>  
            {% endfor %}  
          </select>  
          <input type="hidden" name="apply_system_prompt" value="1">  
          <small class="form-text text-muted">選択すると、その内容がシステムメッセージに反映されます。</small>  
        </div>  
      </form>  
    
      <!-- 新しい指示を登録 -->  
      <h6>指示を登録</h6>  
      <form method="POST" style="margin-bottom: 1em;">  
        <div class="form-group">  
          <label for="prompt_title">タイトル</label>  
          <input type="text" id="prompt_title" name="prompt_title" class="form-control" required>  
        </div>  
        <div class="form-group">  
          <label for="prompt_content">指示内容</label>  
          <textarea id="prompt_content" name="prompt_content" class="form-control" rows="4" required></textarea>  
        </div>  
        <button type="submit" class="btn btn-outline-primary">登録</button>  
        <input type="hidden" name="add_system_prompt" value="1">  
      </form>  
    
      <h4>チャット履歴</h4>  
      <ul class="chat-history" id="chatHistoryList">  
        {% if chat_sessions %}  
          {% if not show_all_history %}  
            {% set display_sessions = chat_sessions[:max_displayed_history] %}  
          {% else %}  
            {% set display_sessions = chat_sessions[:max_total_history] %}  
          {% endif %}  
          {% for chat in display_sessions %}  
            {% set title = chat.first_assistant_message or '新規チャット' %}  
            <li data-session-id="{{ chat.session_id }}">  
              <form method="POST">  
                <input type="hidden" name="select_chat" value="{{ chat.session_id }}">  
                <button type="submit" class="btn btn-link sidebar-button">  
                  {{ title[:10] }}{% if title|length > 10 %}…{% endif %}  
                </button>  
              </form>  
            </li>  
          {% endfor %}  
        {% else %}  
          <p>チャット履歴がありません。</p>  
        {% endif %}  
      </ul>  
      {% if chat_sessions|length > max_displayed_history %}  
        <form method="POST">  
          <button type="submit" name="toggle_history" class="btn btn-secondary">  
            {{ '少なく表示' if show_all_history else 'もっと見る' }}  
          </button>  
        </form>  
      {% endif %}  
      <form method="POST">  
        <button type="submit" name="new_chat" value="true" class="btn btn-primary mt-2">新しいチャット</button>  
      </form>  
    
      <hr>  
      <h4>ファイルアップロード（画像・PDF）</h4>  
      <form method="POST" enctype="multipart/form-data">  
        <div class="form-group">  
          <input type="file" name="files" multiple  
                 class="form-control-file"  
                 accept=".png,.jpg,.jpeg,.gif,.pdf"  
                 onchange="this.form.submit()">  
          <input type="hidden" name="upload_files" value="1">  
        </div>  
      </form>  
    
      {% if images %}  
      <h5>アップロード画像</h5>  
      {% for img in images %}  
        <div class="uploaded-image">  
          <p>{{ img.name }}</p>  
          <img src="{{ img.url }}" alt="{{ img.name }}" width="100%">  
          <form method="post">  
            <input type="hidden" name="delete_image" value="{{ img.blob }}">  
            <button type="submit" class="btn btn-danger btn-sm mt-2">削除</button>  
          </form>  
        </div>  
      {% endfor %}  
      {% endif %}  
    
      {% if files %}  
      <h5>アップロードPDF</h5>  
      {% for f in files %}  
        <div class="uploaded-file">  
          <p><a href="{{ f.url }}" target="_blank" rel="noopener">{{ f.name }}</a></p>  
          <form method="post">  
            <input type="hidden" name="delete_file" value="{{ f.blob }}">  
            <button type="submit" class="btn btn-danger btn-sm mt-2">削除</button>  
          </form>  
        </div>  
      {% endfor %}  
      {% endif %}  
    </div>  
    
    <!-- メインコンテンツ -->  
    <div class="col-md-9 main-content">  
      <div id="mainHeader" class="d-flex align-items-center justify-content-between mb-3">  
        <h1 class="app-title mb-0">PM Compass PRO</h1>  
        <div id="loadingInline">  
          <span class="spinner-border spinner-border-sm text-primary" role="status"></span>  
          <span class="loading-text">応答中です。しばらくお待ちください…</span>  
        </div>  
      </div>  
    
      {% with messages = get_flashed_messages() %}  
      {% if messages %}  
        <ul class="flashes">  
        {% for m in messages %}<li>{{ m }}</li>{% endfor %}  
        </ul>  
      {% endif %}  
      {% endwith %}  
    
      <!-- チャット表示領域 -->  
      <div id="chatBox" class="chat-box">  
        {% for msg in chat_history %}  
          <div class="message-container {% if msg.role=='user' %}user{% else %}assistant{% endif %}">  
            <div class="message-bubble">  
              {% if msg.role=='user' %}  
                <strong>あなた:</strong>  
                <p>{{ msg.content|e }}</p>  
              {% else %}  
                <strong>アシスタント:</strong>  
                {% if msg.type=='html' %}  
                  <div class="assistant-message">{{ msg.content|safe }}</div>  
                {% else %}  
                  <p>{{ msg.content|e }}</p>  
                {% endif %}  
              {% endif %}  
            </div>  
          </div>  
        {% endfor %}  
      </div>  
    
      <!-- RAG文書表示欄 -->  
      <div id="searchFilesDisplay" class="alert alert-secondary" style="display:none;font-size:0.95em;"></div>  
    
      <!-- チャット入力欄 -->  
      <form id="chatForm" class="chat-input">  
        <div class="form-row">  
          <div class="col-10">  
            <textarea name="prompt" id="promptTextarea" class="form-control" rows="2"  
                      placeholder="ご質問を入力してください:"></textarea>  
          </div>  
          <div class="col-2">  
            <button type="submit" id="sendButton" class="btn btn-success btn-block">送信</button>  
          </div>  
        </div>  
      </form>  
    </div>  
  </div>  
</div>  
  
<!-- 現在の会話ID（JSから参照） -->  
<div id="currentSession" data-session-id="{{ session.get('current_session_id','') }}" style="display:none;"></div>  
  
<div id="docModalContainer"></div>  
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>  
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>  
  
<script>  
document.addEventListener('DOMContentLoaded', function() {  
  const promptTextarea = document.getElementById('promptTextarea');  
  if (sessionStorage.getItem('chat_input')) {  
    promptTextarea.value = sessionStorage.getItem('chat_input');  
  }  
  promptTextarea.addEventListener('input', function() {  
    sessionStorage.setItem('chat_input', promptTextarea.value);  
  });  
  document.getElementById('chatForm').addEventListener('submit', function() {  
    sessionStorage.removeItem('chat_input');  
  });  
    
  // MathJax で LaTeX を描画するヘルパー  
  function typesetMath(el) {  
    if (!el) return;  
    if (window.MathJax && window.MathJax.typesetPromise) {  
      MathJax.typesetPromise([el]).catch(function (err) {  
        console.error('MathJax typeset error:', err);  
      });  
    }  
  }  
    
  // 会話IDの取得・更新ヘルパ  
  const currentSessionEl = document.getElementById('currentSession');  
  function getCurrentSessionId() {  
    return currentSessionEl ? (currentSessionEl.dataset.sessionId || '') : '';  
  }  
  function setCurrentSessionId(sid) {  
    if (currentSessionEl) {  
      currentSessionEl.dataset.sessionId = sid || '';  
    }  
  }  
    
  const chatForm = document.getElementById('chatForm');  
  const chatBox = document.getElementById('chatBox');  
  const sendButton = document.getElementById('sendButton');  
  const loadingInline = document.getElementById('loadingInline');  
  const searchFilesDisplay = document.getElementById('searchFilesDisplay');  
  let currentSearchFiles = [];  
    
  let lastUserBubbleEl = null;  
  let isSending = false;  // 送信中フラグ  
    
  function scrollChatToBottom() { chatBox.scrollTop = chatBox.scrollHeight; }  
    
  function escapeHtml(str) {  
    if (!str) return '';  
    return str.replace(/[&<>"']/g, m => (  
      { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]  
    ));  
  }  
    
  function showLoading() { loadingInline.style.display = 'flex'; }  
  function hideLoading() { loadingInline.style.display = 'none'; }  
  hideLoading();  
    
  function appendUserMessage(message) {  
    const c = document.createElement('div');  
    c.className = 'message-container user';  
    c.innerHTML = `<div class="message-bubble">  
        <strong>あなた:</strong><p>${escapeHtml(message)}</p>  
      </div>`;  
    chatBox.appendChild(c);  
    scrollChatToBottom();  
    const bubble = c.querySelector('.message-bubble');  
    lastUserBubbleEl = bubble;  
    return bubble;  
  }  
    
  // デバッグ情報をアシスタントメッセージの下に表示  
  function appendDebugBlock(bubbleEl, title, debugObj) {  
    if (!bubbleEl || !debugObj) return;  
    try {  
      const details = document.createElement('details');  
      details.className = 'debug-block';  
      details.open = false;  
    
      const summary = document.createElement('summary');  
      summary.textContent = title || '送信内容デバッグ';  
    
      const pre = document.createElement('pre');  
      pre.textContent = JSON.stringify(debugObj, null, 2);  
    
      details.appendChild(summary);  
      details.appendChild(pre);  
      bubbleEl.appendChild(details);  
      scrollChatToBottom();  
    } catch (e) {  
      console.error('appendDebugBlock error:', e);  
    }  
  }  
    
  function renderRewrittenQueriesUnder(targetBubbleEl, payload) {  
    try {  
      if (!targetBubbleEl) return;  
      const queries = Array.isArray(payload?.queries)  
        ? payload.queries.map(s => typeof s === 'string' ? s.trim() : '').filter(Boolean)  
        : [];  
      if (queries.length === 0) return;  
    
      const baseQuery = (typeof payload?.base_query === 'string' ? payload.base_query.trim() : '');  
      const clarify = payload?.needs_clarification === true;  
    
      const old = targetBubbleEl.querySelector('.rewritten-queries');  
      if (old) old.remove();  
    
      const wrap = document.createElement('div');  
      wrap.className = 'rewritten-queries';  
      const title = document.createElement('div');  
      title.className = 'rq-title';  
      title.textContent = clarify  
        ? 'クエリリライト（検索に使用・要確認の可能性）'  
        : 'クエリリライト（検索に使用）';  
      const list = document.createElement('ul');  
      list.className = 'rq-list';  
    
      if (baseQuery && !queries.includes(baseQuery)) {  
        const li0 = document.createElement('li');  
        li0.textContent = baseQuery + '（基準）';  
        list.appendChild(li0);  
      }  
      queries.forEach(q => {  
        const li = document.createElement('li');  
        li.textContent = q;  
        list.appendChild(li);  
      });  
    
      wrap.appendChild(title);  
      wrap.appendChild(list);  
      targetBubbleEl.appendChild(wrap);  
      scrollChatToBottom();  
    } catch (_) {}  
  }  
    
  // アシスタント用メッセージコンテナ  
  function appendAssistantStreamContainer() {  
    const c = document.createElement('div');  
    c.className = 'message-container assistant';  
    c.innerHTML = `<div class="message-bubble">  
        <strong>アシスタント:</strong>  
        <div class="assistant-message"></div>  
      </div>`;  
    chatBox.appendChild(c);  
    scrollChatToBottom();  
    const msgEl = c.querySelector('.assistant-message');  
    const bubbleEl = c.querySelector('.message-bubble');  
    return { msgEl, bubbleEl };  
  }  
    
  function replaceAssistantContainerHtml(targetEl, html) {  
    if (targetEl) targetEl.innerHTML = html;  
  }  
    
  function updateAssistantContainerText(targetEl, text) {  
    if (targetEl) targetEl.textContent = text;  
  }  
    
  function appendReasoningSummary(summary) {  
    if (summary && summary !== 'detailed') {  
      const c = document.createElement('div');  
      c.className = 'reasoning-summary alert alert-info mt-2';  
      c.innerHTML = `<strong>Reasoning summary:</strong><br>${escapeHtml(summary)}`;  
      chatBox.appendChild(c);  
      scrollChatToBottom();  
    }  
  }  
    
  function clearSearchFilesDisplay() {  
    searchFilesDisplay.style.display = "none";  
    searchFilesDisplay.innerHTML = "";  
    currentSearchFiles = [];  
  }  
    
  // RAG 検索結果表示  
  function renderSearchFiles(files) {  
    if (!Array.isArray(files) || files.length === 0) {  
      clearSearchFilesDisplay();  
      return;  
    }  
    searchFilesDisplay.style.display = 'block';  
    currentSearchFiles = files;  
    
    let title = `<span id="searchFilesToggle" style="cursor:pointer; text-decoration:underline;">この質問で検索に利用された文書</span>`;  
    let ul = `<div id="searchFilesUlContainer" style="display:none;" tabindex="0"><ul>`;  
    files.forEach((file, idx) => {  
      let safeHref = '';  
      if (typeof file?.url === 'string') {  
        safeHref = file.url.startsWith('/download_') ? file.url : encodeURI(file.url);  
      }  
      const dlBtn = (safeHref)  
        ? `<a href="${safeHref}" download style="margin-left:8px;" class="btn btn-link btn-sm" title="ダウンロード" target="_blank" rel="noopener"><span class="fa fa-download"></span>ダウンロード</a>`  
        : '';  
      const folderText = (typeof file?.folder === 'string' && file.folder)  
        ? ` <span class="small-muted">(${escapeHtml(file.folder)})</span>` : '';  
      ul += `<li><span class="doc-num">${idx + 1}.</span> <a href="#" class="doclink" data-docidx="${idx}" style="text-decoration:underline; cursor:pointer">${escapeHtml(file.title)}</a>${folderText} ${dlBtn}</li>`;  
    });  
    ul += `</ul></div>`;  
    
    searchFilesDisplay.innerHTML = title + ul;  
    setTimeout(function(){  
      let toggler = document.getElementById('searchFilesToggle');  
      let ulDiv = document.getElementById('searchFilesUlContainer');  
      if (toggler && ulDiv) {  
        toggler.addEventListener('click', function(){  
          ulDiv.style.display = (ulDiv.style.display==="none") ? "block" : "none";  
          if (ulDiv.style.display === "block") ulDiv.focus();  
        });  
      }  
    }, 50);  
  }  
    
  function extractTitleFromHtml(html, maxLen = 10) {  
    const tmp = document.createElement('div');  
    tmp.innerHTML = html || '';  
    const text = (tmp.textContent || tmp.innerText || '').trim();  
    if (!text) return '無題';  
    return text.length > maxLen ? text.slice(0, maxLen) + '…' : text;  
  }  
    
  function upsertSidebarItemById(sid, title) {  
    if (!sid) return;  
    const ul = document.getElementById('chatHistoryList');  
    if (!ul) return;  
    let li = ul.querySelector('li[data-session-id="' + sid + '"]');  
    const safeTitle = escapeHtml(title || '無題');  
    if (!li) {  
      li = document.createElement('li');  
      li.setAttribute('data-session-id', sid);  
      li.innerHTML = `  
        <form method="POST">  
          <input type="hidden" name="select_chat" value="${sid}">  
          <button type="submit" class="btn btn-link sidebar-button">${safeTitle}</button>  
        </form>`;  
      ul.insertBefore(li, ul.firstChild);  
    } else {  
      const btn = li.querySelector('button.sidebar-button');  
      if (btn) btn.textContent = title || '無題';  
    }  
  }  
    
  // SSE ストリーミング  
  function startSSE(prompt) {  
    const { msgEl: streamEl, bubbleEl: assistantBubble } = appendAssistantStreamContainer();  
    let accText = '';  
    let finished = false;  
    
    sendButton.disabled = true;  
    showLoading();  
    clearSearchFilesDisplay();  
    
    fetch('/prepare_stream', {  
      method: 'POST',  
      headers: {'Content-Type': 'application/json'},  
      body: JSON.stringify({  
        prompt: prompt,  
        session_id: getCurrentSessionId()  
      })  
    })  
    .then(r => {  
      if (!r.ok) throw new Error('prepare_stream failed');  
      return r.json();  
    })  
    .then(({ message_id }) => {  
      if (!message_id) throw new Error('no message_id');  
    
      const sid = getCurrentSessionId();  
      const esUrl = '/stream_message?mid=' + encodeURIComponent(message_id)  
                  + (sid ? '&sid=' + encodeURIComponent(sid) : '');  
      const es = new EventSource(esUrl);  
    
      es.addEventListener('rewritten_queries', ev => {  
        try { renderRewrittenQueriesUnder(lastUserBubbleEl, JSON.parse(ev.data)); } catch (_) {}  
      });  
      es.addEventListener('search_files', ev => {  
        try { renderSearchFiles(JSON.parse(ev.data)); } catch (_) {}  
      });  
      es.addEventListener('delta', ev => {  
        try {  
          const data = JSON.parse(ev.data);  
          if (data && typeof data.text === 'string') {  
            accText += data.text;  
            updateAssistantContainerText(streamEl, accText);  
          }  
        } catch (_) {}  
      });  
      es.addEventListener('final', ev => {  
        try {  
          const data = JSON.parse(ev.data);  
          if (data && typeof data.html === 'string') {  
            replaceAssistantContainerHtml(streamEl, data.html);  
    
            // LaTeX を描画  
            typesetMath(streamEl);  
    
            const title = extractTitleFromHtml(data.html, 10);  
            const sid2 = data.session_id || getCurrentSessionId();  
            if (sid2) {  
              upsertSidebarItemById(sid2, title);  
              setCurrentSessionId(sid2);  
            }  
          }  
        } catch (_) {}  
      });  
      es.addEventListener('reasoning_summary', ev => {  
        try {  
          const data = JSON.parse(ev.data);  
          if (data && typeof data.summary === 'string' && data.summary) {  
            appendReasoningSummary(data.summary);  
          }  
        } catch (_) {}  
      });  
    
      // debug イベント  
      es.addEventListener('debug', ev => {  
        try {  
          const data = JSON.parse(ev.data);  
          console.log('DEBUG from server:', data);  
          appendDebugBlock(assistantBubble, '送信内容デバッグ', data);  
        } catch (e) {  
          console.error('SSE debug event error:', e);  
        }  
      });  
    
      es.addEventListener('error', ev => {  
        try { console.error('SSE error event:', JSON.parse(ev.data)); } catch (_) {}  
      });  
      es.addEventListener('done', ev => {  
        finished = true;  
        es.close();  
        sendButton.disabled = false;  
        hideLoading();  
        isSending = false;  
        scrollChatToBottom();  
      });  
      es.onerror = function(err) {  
        console.error('SSE connection error:', err);  
        if (finished) return;  
        es.close();  
        sendButton.disabled = false;  
        hideLoading();  
        // SSE失敗時は JSON フォールバック  
        fallbackJsonSubmit(prompt);  
      };  
    })  
    .catch(err => {  
      console.error(err);  
      sendButton.disabled = false;  
      hideLoading();  
      isSending = false;  
      alert('送信に失敗しました');  
    });  
  }  
    
  // 非ストリーミング JSON フォールバック  
  function fallbackJsonSubmit(prompt) {  
    sendButton.disabled = true;  
    showLoading();  
    clearSearchFilesDisplay();  
    
    fetch('/send_message', {  
      method: 'POST',  
      headers: {'Content-Type': 'application/json'},  
      body: JSON.stringify({  
        prompt: prompt,  
        session_id: getCurrentSessionId()  
      })  
    })  
    .then(r => r.json())  
    .then(data => {  
      if (Array.isArray(data.rewritten_queries)) {  
        renderRewrittenQueriesUnder(lastUserBubbleEl, { queries: data.rewritten_queries });  
      }  
      let assistantEl = null;  
      let bubbleEl = null;  
      if (data.response) {  
        const c = document.createElement('div');  
        c.className = 'message-container assistant';  
        c.innerHTML = `<div class="message-bubble">  
            <strong>アシスタント:</strong>  
            <div class="assistant-message">${data.response}</div>  
          </div>`;  
        chatBox.appendChild(c);  
        assistantEl = c.querySelector('.assistant-message');  
        bubbleEl = c.querySelector('.message-bubble');  
    
        // LaTeX を描画  
        typesetMath(assistantEl);  
    
        const t = extractTitleFromHtml(data.response, 10);  
        const sid = data.session_id || getCurrentSessionId();  
        if (sid) {  
          upsertSidebarItemById(sid, t);  
          setCurrentSessionId(sid);  
        }  
      }  
      if (Array.isArray(data.search_files) && data.search_files.length > 0) {  
        renderSearchFiles(data.search_files);  
      } else {  
        clearSearchFilesDisplay();  
      }  
    
      if (data.debug && bubbleEl) {  
        console.log('DEBUG from /send_message:', data.debug);  
        appendDebugBlock(bubbleEl, '送信内容デバッグ', data.debug);  
      }  
    })  
    .catch(e => {  
      console.error(e);  
      alert('エラーが発生しました');  
    })  
    .finally(() => {  
      sendButton.disabled = false;  
      hideLoading();  
      isSending = false;  
      scrollChatToBottom();  
    });  
  }  
    
  // フォーム送信ハンドラ  
  document.getElementById('chatForm').addEventListener('submit', e => {  
    e.preventDefault();  
    if (isSending) return;  
    const prompt = promptTextarea.value.trim();  
    if (!prompt) return;  
    isSending = true;  
    const bubble = appendUserMessage(prompt);  
    lastUserBubbleEl = bubble;  
    promptTextarea.value = '';  
    
    if (window.EventSource) {  
      startSSE(prompt);  
    } else {  
      fallbackJsonSubmit(prompt);  
    }  
  });  
    
  // RAG文書クリック時のモーダル表示  
  searchFilesDisplay.addEventListener('click', function(e) {  
    if (e.target && e.target.classList.contains('doclink')) {  
      e.preventDefault();  
      const idx = e.target.getAttribute('data-docidx');  
      const doc = currentSearchFiles && currentSearchFiles[idx];  
      if (doc) {  
        let modalHtml = `  
          <div class="modal fade" id="docModal" tabindex="-1">  
            <div class="modal-dialog modal-lg"><div class="modal-content">  
            <div class="modal-header">  
              <h5 class="modal-title"></h5>  
              <button type="button" class="close" data-dismiss="modal">&times;</button>  
            </div>  
            <div class="modal-body" style="white-space:pre-wrap; font-family:monospace; max-height:60vh; overflow:auto;"></div>  
            </div></div>  
          </div>`;  
        let modalContainer = document.getElementById('docModalContainer');  
        modalContainer.innerHTML = modalHtml;  
        $('#docModal .modal-title').text(doc.title);  
        $('#docModal .modal-body').text(doc.content);  
        $('#docModal').modal('show');  
      }  
    }  
  });  
    
  // Enter で送信（Shift+Enter は改行）  
  const promptTextareaEl = document.getElementById('promptTextarea');  
  promptTextareaEl.addEventListener('keydown', e => {  
    if (e.key==='Enter' && !e.shiftKey) {  
      e.preventDefault();  
      document.getElementById('chatForm').dispatchEvent(new Event('submit'));  
    }  
  });  
    
  // 初期スクロール  
  (function(){ chatBox.scrollTop = chatBox.scrollHeight; })();  
    
  // 初期表示の履歴メッセージを MathJax でレンダリング  
  typesetMath(chatBox);  
    
  // 設定を /update_settings に送る共通関数  
  function postSettings(payload) {  
    return fetch('/update_settings', {  
      method: 'POST',  
      headers: { 'Content-Type': 'application/json' },  
      body: JSON.stringify(payload)  
    }).then(r => {  
      if (!r.ok) throw new Error('update_settings failed');  
      return r.json();  
    }).catch(e => console.error(e));  
  }  
    
  // モデル選択・reasoning_effort  
  const modelSelect = document.getElementById('model_select');  
  const reasoningEffortSelect = document.getElementById('reasoning_effort');  
  function updateReasoningSelectState(model) {  
    const enabledModels = ['o3','o4-mini','gpt-5'];  
    if (reasoningEffortSelect) {  
      reasoningEffortSelect.disabled = !enabledModels.includes(model);  
    }  
  }  
  if (modelSelect) {  
    modelSelect.addEventListener('change', function() {  
      const model = this.value;  
      postSettings({ selected_model: model }).then(() => updateReasoningSelectState(model));  
    });  
    updateReasoningSelectState(modelSelect.value);  
  }  
  if (reasoningEffortSelect) {  
    reasoningEffortSelect.addEventListener('change', function() {  
      postSettings({ reasoning_effort: this.value });  
    });  
  }  
    
  // インデックス選択  
  const indexSelect = document.getElementById('index_select');  
  if (indexSelect) {  
    indexSelect.addEventListener('change', function() {  
      postSettings({ selected_search_index: this.value });  
    });  
  }  
    
  // doc_count  
  const docCountInput = document.getElementById('doc_count');  
  if (docCountInput) {  
    docCountInput.addEventListener('change', function() {  
      const v = parseInt(this.value, 10);  
      postSettings({ doc_count: isNaN(v) ? 10 : v });  
    });  
  }  
    
  // history_to_send  
  const histInput = document.getElementById('history_to_send');  
  if (histInput) {  
    histInput.addEventListener('change', function() {  
      const v = parseInt(this.value, 10);  
      postSettings({ history_to_send: isNaN(v) ? 10 : v });  
    });  
  }  
    
  // system_message（blur時に保存）  
  const sysMsgTextarea = document.querySelector('textarea[name="system_message"]');  
  if (sysMsgTextarea) {  
    sysMsgTextarea.addEventListener('blur', function() {  
      postSettings({ default_system_message: this.value });  
    });  
  }  
    
  // RAG スイッチ  
  const ragSwitch = document.getElementById('ragEnabled');  
  if (ragSwitch) {  
    ragSwitch.addEventListener('change', function() {  
      postSettings({ rag_enabled: this.checked });  
    });  
  }  
});  
</script>  
  
<!-- 最後のタブ/ウィンドウが閉じられたときにセッションのアップロードを自動削除 -->  
<script>  
(function(){  
  if (!('sendBeacon' in navigator)) { return; }  
  const KEY = 'pmc_active_tabs';  
  let cleaned = false;  
    
  function get() { try { return parseInt(localStorage.getItem(KEY) || '0', 10) || 0; } catch (e) { return 0; } }  
  function set(v) { try { localStorage.setItem(KEY, String(v)); } catch (e) {} }  
  function inc() { set(get() + 1); }  
  function dec() { const v = Math.max(0, get() - 1); set(v); return v; }  
    
  function sendCleanupOnce() {  
    if (cleaned) return;  
    cleaned = true;  
    const remaining = dec();  
    if (remaining === 0) {  
      const payload = JSON.stringify({ reason: 'session_end' });  
      const blob = new Blob([payload], { type: 'application/json' });  
      navigator.sendBeacon('{{ url_for("cleanup_session_files") }}', blob);  
    }  
  }  
    
  window.addEventListener('pageshow', inc, { once: true });  
  window.addEventListener('pagehide', sendCleanupOnce, { capture: true });  
  window.addEventListener('beforeunload', sendCleanupOnce);  
  document.addEventListener('visibilitychange', function () {  
    if (document.visibilityState === 'hidden') sendCleanupOnce();  
  });  
})();  
</script>  
</body>  
</html>  